<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0b0f1a">
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <link rel="manifest" href="manifest.json">
  <title>LIMIAR ‚Äî Ambiente de Estudo</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #070a12;
      --bg-soft: #141a2a;
      --accent: #b48b62;
      --text: #f1efe9;
      --muted: rgba(241, 239, 233, 0.7);
      --divider: rgba(241, 239, 233, 0.14);
      --card: rgba(16, 21, 36, 0.82);
      --mist: rgba(120, 150, 200, 0.12);
      --moon: rgba(210, 220, 255, 0.14);
      --moon-strong: rgba(210, 220, 255, 0.28);
      --moon-warm: rgba(230, 200, 160, 0.25);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Georgia", serif;
      background:
        radial-gradient(circle at 15% 20%, rgba(180, 210, 255, 0.12) 0%, rgba(7, 10, 18, 0) 45%),
        radial-gradient(circle at 85% 10%, rgba(255, 210, 170, 0.08) 0%, rgba(7, 10, 18, 0) 50%),
        linear-gradient(180deg, #0c1220 0%, #070a12 55%, #05070d 100%);
      color: var(--text);
      min-height: 100vh;
    }

    main {
      padding: 28px 22px 90px;
      position: relative;
      overflow: hidden;
    }

    .screen {
      display: none;
      min-height: calc(100vh - 90px);
      position: relative;
      z-index: 2;
    }

    .screen.active {
      display: block;
    }

    h1, h2, h3 {
      margin: 0 0 12px;
      font-weight: 500;
    }

    p {
      line-height: 1.6;
      margin: 0 0 16px;
    }

    button {
      width: 100%;
      border: none;
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 16px;
      font-family: inherit;
      background: #1b2436;
      color: var(--text);
      margin-top: 10px;
      transition: background 0.2s ease;
    }

    button:hover {
      background: #26314a;
    }

    button.secondary {
      background: transparent;
      border: 1px solid var(--divider);
      color: var(--muted);
    }

    .small {
      font-size: 14px;
      color: var(--muted);
    }

    .divider {
      border-top: 1px solid var(--divider);
      margin: 20px 0;
    }

    .card {
      background: var(--card);
      padding: 16px;
      border-radius: 14px;
      margin-bottom: 16px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
    }

    .menu {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(8, 11, 20, 0.92);
      backdrop-filter: blur(8px);
      display: flex;
      justify-content: space-around;
      padding: 10px 8px 16px;
      border-top: 1px solid var(--divider);
      z-index: 5;
    }

    .menu button {
      width: auto;
      background: transparent;
      border: none;
      color: var(--muted);
      margin: 0;
      font-size: 14px;
      padding: 6px 12px;
    }

    .menu button.active {
      color: var(--text);
      border-bottom: 2px solid var(--accent);
    }

    .tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--accent);
      border: 1px solid rgba(194, 154, 91, 0.3);
      margin-bottom: 8px;
    }

    .ritual {
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 80vh;
    }

    .rain {
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--muted);
    }

    .rain-toggle {
      width: auto;
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid var(--divider);
      background: transparent;
      color: var(--muted);
    }

    .rain-active {
      color: var(--accent);
      border-color: rgba(194, 154, 91, 0.5);
    }

    .hint-grid button {
      text-align: left;
    }

    textarea {
      width: 100%;
      min-height: 40vh;
      background: rgba(9, 12, 22, 0.9);
      border: 1px solid var(--divider);
      border-radius: 12px;
      padding: 16px;
      color: var(--text);
      font-family: inherit;
      font-size: 16px;
      line-height: 1.6;
    }

    .status {
      font-size: 13px;
      color: var(--accent);
    }

    .list-item {
      padding: 14px 0;
      border-bottom: 1px solid var(--divider);
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .ghost {
      opacity: 0.6;
    }

    .sky {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }

    .moon {
      position: absolute;
      border-radius: 50%;
      filter: blur(0.2px);
      box-shadow: 0 0 40px var(--moon-strong);
      background: radial-gradient(circle at 30% 30%, rgba(240, 245, 255, 0.7) 0%, rgba(200, 210, 245, 0.4) 45%, rgba(140, 160, 210, 0.1) 70%, rgba(7, 10, 18, 0) 100%);
    }

    .moon.primary {
      width: 240px;
      height: 240px;
      top: -40px;
      right: -40px;
      opacity: 0.75;
    }

    .moon.secondary {
      width: 140px;
      height: 140px;
      top: 40px;
      right: 140px;
      opacity: 0.45;
      box-shadow: 0 0 30px var(--moon-warm);
      background: radial-gradient(circle at 35% 35%, rgba(255, 235, 210, 0.5) 0%, rgba(220, 190, 150, 0.3) 45%, rgba(10, 12, 20, 0) 70%);
    }

    .mist {
      position: absolute;
      inset: 35% -20% auto -20%;
      height: 280px;
      background: radial-gradient(circle at 30% 20%, var(--mist) 0%, rgba(7, 10, 18, 0) 70%);
      opacity: 0.8;
    }

    .stars {
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(2px 2px at 20% 30%, rgba(255, 255, 255, 0.15) 0%, transparent 60%),
        radial-gradient(1px 1px at 60% 20%, rgba(255, 255, 255, 0.12) 0%, transparent 60%),
        radial-gradient(1px 1px at 80% 35%, rgba(255, 255, 255, 0.1) 0%, transparent 60%),
        radial-gradient(1px 1px at 40% 50%, rgba(255, 255, 255, 0.12) 0%, transparent 60%),
        radial-gradient(2px 2px at 70% 60%, rgba(255, 255, 255, 0.08) 0%, transparent 60%),
        radial-gradient(1px 1px at 30% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 60%);
      opacity: 0.4;
    }

    .glow-line {
      position: absolute;
      left: -10%;
      right: -10%;
      top: 120px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(180, 210, 255, 0.3), transparent);
      opacity: 0.5;
    }

    .scene-label {
      font-size: 12px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: rgba(230, 220, 200, 0.55);
    }

    .library-scene {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 90px;
    }

    .library-room {
      width: min(900px, 92vw);
      height: 55vh;
      position: relative;
      border-radius: 24px 24px 40px 40px;
      background: linear-gradient(180deg, rgba(12, 15, 26, 0.92) 0%, rgba(7, 9, 15, 0.95) 100%);
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(200, 190, 170, 0.12);
      overflow: hidden;
    }

    .wall-glow {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 20%, rgba(200, 170, 120, 0.12) 0%, transparent 60%);
    }

    .shelves {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 55%;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      padding: 18px 22px 40px;
    }

    .shelf {
      background: rgba(25, 32, 50, 0.75);
      border: 1px solid rgba(180, 170, 150, 0.08);
      border-radius: 16px;
      position: relative;
      overflow: hidden;
    }

    .shelf::before {
      content: "";
      position: absolute;
      inset: 10% 6% 15%;
      background:
        repeating-linear-gradient(90deg, rgba(120, 140, 180, 0.2) 0 10%, transparent 10% 14%),
        repeating-linear-gradient(90deg, rgba(160, 120, 90, 0.2) 0 12%, transparent 12% 18%);
      opacity: 0.6;
    }

    .desk {
      position: absolute;
      bottom: 16px;
      left: 50%;
      width: 55%;
      height: 18%;
      transform: translateX(-50%);
      background: linear-gradient(180deg, rgba(70, 50, 35, 0.8) 0%, rgba(40, 28, 20, 0.9) 100%);
      border-radius: 16px;
      box-shadow: 0 -8px 24px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(180, 150, 110, 0.2);
    }

    .desk::before {
      content: "";
      position: absolute;
      left: 12%;
      top: -30px;
      width: 76%;
      height: 26px;
      background: rgba(180, 160, 120, 0.2);
      border-radius: 8px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.35);
    }

    .door {
      position: absolute;
      top: 18%;
      right: 8%;
      width: 12%;
      height: 45%;
      background: linear-gradient(180deg, rgba(30, 24, 20, 0.9) 0%, rgba(18, 12, 10, 0.95) 100%);
      border-radius: 12px;
      border: 1px solid rgba(180, 150, 120, 0.2);
      box-shadow: inset 0 0 18px rgba(0, 0, 0, 0.4);
    }

    .door::after {
      content: "";
      position: absolute;
      right: 18%;
      top: 50%;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(200, 170, 120, 0.6);
      transform: translateY(-50%);
    }

    .map-frame {
      position: absolute;
      top: 16%;
      left: 10%;
      width: 18%;
      height: 20%;
      border: 1px solid rgba(200, 180, 140, 0.4);
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(80, 70, 50, 0.4) 0%, rgba(30, 25, 20, 0.8) 100%);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.4);
    }

    .map-frame::before {
      content: "";
      position: absolute;
      inset: 10%;
      background: radial-gradient(circle at 40% 30%, rgba(180, 150, 110, 0.35) 0%, transparent 60%);
    }
  </style>
</head>
<body>
  <div class="sky" aria-hidden="true">
    <div class="stars"></div>
    <div class="moon primary"></div>
    <div class="moon secondary"></div>
    <div class="mist"></div>
    <div class="glow-line"></div>
  </div>
  <div class="library-scene" aria-hidden="true">
    <div class="library-room">
      <div class="wall-glow"></div>
      <div class="map-frame"></div>
      <div class="door"></div>
      <div class="shelves">
        <div class="shelf"></div>
        <div class="shelf"></div>
        <div class="shelf"></div>
      </div>
      <div class="desk"></div>
    </div>
  </div>
  <main>
    <section id="screen-start" class="screen active">
      <div class="rain">
        <span>üîà Ambiente</span>
        <button class="rain-toggle" id="rainToggle">Ativar chuva</button>
      </div>
      <div class="ritual">
        <p class="scene-label">Biblioteca antiga ¬∑ noite cont√≠nua</p>
        <p style="font-size: 22px;">
          Nem tudo precisa ser vencido.<br>
          Algumas coisas precisam ser atravessadas.
        </p>
        <button id="enterBtn">Entrar</button>
      </div>
    </section>

    <section id="screen-explore" class="screen">
      <div class="tag">Explorar</div>
      <h2>Biblioteca do Limiar</h2>
      <p class="small">Escolha um fragmento para atravessar.</p>
      <div id="fragmentList"></div>
    </section>

    <section id="screen-fragment" class="screen">
      <div class="tag" id="fragmentLocation"></div>
      <h2 id="fragmentTitle"></h2>
      <p id="fragmentText"></p>
      <p class="status" id="fragmentStatus"></p>
      <div class="divider"></div>
      <button id="btnTrue">Verdadeiro</button>
      <button id="btnFalse">Falso</button>
      <button class="secondary" id="btnDoubt">Estou em d√∫vida</button>
    </section>

    <section id="screen-hints" class="screen">
      <div class="tag">Estou em d√∫vida</div>
      <h2>Dicas sob demanda</h2>
      <p class="small" id="hintPrompt"></p>
      <div class="hint-grid" id="hintButtons"></div>
      <div class="card" id="hintContent" style="display:none;"></div>
      <button class="secondary" id="backToFragment">Voltar ao fragmento</button>
    </section>

    <section id="screen-feedback" class="screen">
      <div class="tag">Retorno</div>
      <h2 id="feedbackTitle"></h2>
      <p id="feedbackText"></p>
      <div class="card" id="feedbackDetail" style="display:none;"></div>
      <button id="backToExplore">Voltar √† biblioteca</button>
    </section>

    <section id="screen-review" class="screen">
      <div class="tag">Voltar depois</div>
      <h2>Revis√µes silenciosas</h2>
      <p class="small">Fragmentos organizados por tempo de retorno.</p>
      <div id="reviewList" class="card"></div>
    </section>

    <section id="screen-diary" class="screen">
      <div class="tag">Di√°rio</div>
      <h2>Registro subjetivo</h2>
      <p class="small">O que esse fragmento te fez pensar hoje?</p>
      <textarea id="diaryInput" placeholder="Escreva livremente..."></textarea>
      <p class="small" id="diaryStatus"></p>
    </section>
  </main>

  <nav class="menu" id="mainMenu" style="display:none;">
    <button data-screen="screen-explore" class="active">Explorar</button>
    <button data-screen="screen-review">Voltar depois</button>
    <button data-screen="screen-diary">Di√°rio</button>
  </nav>

  <script>
    const fragments = [
      {
        id: "frag-constitucional-1",
        title: "Fragmento 01",
        location: "Mesa ¬∑ Constitucional",
        text: "A dignidade da pessoa humana √© fundamento da Rep√∫blica Federativa do Brasil.",
        answer: true,
        rationale: "Art. 1¬∫, III, da Constitui√ß√£o Federal consagra a dignidade da pessoa humana como fundamento da Rep√∫blica.",
        tips: {
          lembrar: "SO CI DI VA PLU: a sigla dos fundamentos. Identifique 'DI' como dignidade da pessoa humana.",
          pensar: "Se √© fundamento, n√£o √© apenas objetivo. Fundamentos est√£o no Art. 1¬∫.",
          organizar: "Fundamentos (Art. 1¬∫) ‚â† Objetivos (Art. 3¬∫). Fa√ßa o mapa mental dos dois blocos.",
          eliminar: "Quando a banca fala em fundamento, descarte itens t√≠picos de objetivos sociais."
        }
      },
      {
        id: "frag-constitucional-2",
        title: "Fragmento 02",
        location: "Mesa ¬∑ Constitucional",
        text: "Os direitos e garantias expressos na Constitui√ß√£o n√£o excluem outros decorrentes do regime e dos princ√≠pios por ela adotados.",
        answer: true,
        rationale: "Art. 5¬∫, ¬ß 2¬∫, da Constitui√ß√£o Federal prev√™ a cl√°usula de abertura material dos direitos fundamentais.",
        tips: {
          lembrar: "Art. 5¬∫, ¬ß 2¬∫: cat√°logo aberto de direitos.",
          pensar: "A Constitui√ß√£o admite direitos impl√≠citos quando compat√≠veis com seus princ√≠pios.",
          organizar: "Direitos expressos + direitos decorrentes do regime/princ√≠pios = conjunto protegido.",
          eliminar: "Se a afirma√ß√£o reconhece a abertura do cat√°logo, tende a estar correta."
        }
      },
      {
        id: "frag-constitucional-3",
        title: "Fragmento 03",
        location: "Mesa ¬∑ Constitucional",
        text: "A cria√ß√£o de partido pol√≠tico depende de autoriza√ß√£o pr√©via do Estado.",
        answer: false,
        rationale: "A cria√ß√£o de partidos √© livre, desde que respeitados a soberania nacional, o regime democr√°tico e o pluripartidarismo (CF, art. 17).",
        tips: {
          lembrar: "Partidos t√™m autonomia e n√£o precisam de autoriza√ß√£o pr√©via.",
          pensar: "A Constitui√ß√£o protege o pluralismo pol√≠tico.",
          organizar: "Art. 17: liberdade partid√°ria com requisitos constitucionais.",
          eliminar: "Afirma√ß√µes com 'autoriza√ß√£o pr√©via do Estado' tendem a ser falsas."
        }
      },
      {
        id: "frag-administrativo-1",
        title: "Fragmento 04",
        location: "Estante ¬∑ Administrativo",
        text: "O princ√≠pio da efici√™ncia n√£o se aplica ao Poder Legislativo.",
        answer: false,
        rationale: "O princ√≠pio da efici√™ncia √© aplic√°vel √† administra√ß√£o p√∫blica direta e indireta de todos os Poderes (CF, art. 37).",
        tips: {
          lembrar: "O art. 37 come√ßa com 'A administra√ß√£o p√∫blica... dos Poderes'.",
          pensar: "A Constitui√ß√£o n√£o criou exce√ß√£o para o Legislativo.",
          organizar: "Administra√ß√£o p√∫blica = Executivo, Legislativo e Judici√°rio quando atuam administrativamente.",
          eliminar: "Se a frase exclui um Poder sem base expressa, tende a estar errada."
        }
      },
      {
        id: "frag-administrativo-2",
        title: "Fragmento 05",
        location: "Estante ¬∑ Administrativo",
        text: "A investidura em cargo ou emprego p√∫blico depende de aprova√ß√£o pr√©via em concurso p√∫blico, ressalvadas as nomea√ß√µes para cargo em comiss√£o.",
        answer: true,
        rationale: "A regra do concurso p√∫blico est√° no art. 37, II, com exce√ß√£o para cargos em comiss√£o.",
        tips: {
          lembrar: "Art. 37, II: concurso como regra, comiss√£o como exce√ß√£o.",
          pensar: "Cargos em comiss√£o s√£o de livre nomea√ß√£o e exonera√ß√£o.",
          organizar: "Regra geral + exce√ß√µes expl√≠citas para comiss√£o.",
          eliminar: "Afirma√ß√£o alinhada ao art. 37, II tende a ser correta."
        }
      },
      {
        id: "frag-administrativo-3",
        title: "Fragmento 06",
        location: "Estante ¬∑ Administrativo",
        text: "A administra√ß√£o p√∫blica pode revogar seus pr√≥prios atos quando ilegais, por motivo de conveni√™ncia e oportunidade.",
        answer: false,
        rationale: "Atos ilegais s√£o anulados; revoga√ß√£o ocorre por conveni√™ncia e oportunidade de atos v√°lidos (S√∫mula 473/STF).",
        tips: {
          lembrar: "Anular = ilegalidade; revogar = m√©rito.",
          pensar: "N√£o se revoga o que nasceu ilegal.",
          organizar: "Controle interno: anula√ß√£o x revoga√ß√£o.",
          eliminar: "Misturar ilegalidade com revoga√ß√£o indica erro."
        }
      },
      {
        id: "frag-legislativo-1",
        title: "Fragmento 07",
        location: "Mapa ¬∑ Processo Legislativo",
        text: "A iniciativa das leis complementares pode ser exercida por qualquer deputado.",
        answer: true,
        rationale: "A iniciativa das leis complementares segue a regra geral, podendo ser proposta por qualquer membro do Congresso (CF, art. 61).",
        tips: {
          lembrar: "Iniciativa de lei complementar segue o regime geral do art. 61.",
          pensar: "Restri√ß√µes de iniciativa s√£o exce√ß√µes expressas.",
          organizar: "Iniciativa geral x iniciativa reservada.",
          eliminar: "Sem iniciativa privativa indicada, a regra √© geral."
        }
      },
      {
        id: "frag-legislativo-2",
        title: "Fragmento 08",
        location: "Mapa ¬∑ Processo Legislativo",
        text: "A aprova√ß√£o de emenda constitucional exige tr√™s quintos dos votos, em dois turnos, em cada Casa do Congresso Nacional.",
        answer: true,
        rationale: "Art. 60, ¬ß 2¬∫, da Constitui√ß√£o Federal define o qu√≥rum e os dois turnos em cada Casa.",
        tips: {
          lembrar: "PEC = 3/5 + 2 turnos + C√¢mara e Senado.",
          pensar: "Emenda constitucional tem rito mais rigoroso.",
          organizar: "Qu√≥rum qualificado x qu√≥rum simples.",
          eliminar: "Se faltar algum elemento (3/5, dois turnos, cada Casa), est√° errado."
        }
      },
      {
        id: "frag-legislativo-3",
        title: "Fragmento 09",
        location: "Mapa ¬∑ Processo Legislativo",
        text: "Medida provis√≥ria perde efic√°cia desde a edi√ß√£o se n√£o for convertida em lei em at√© sessenta dias, prorrog√°veis uma vez por igual per√≠odo.",
        answer: true,
        rationale: "A MP tem prazo de 60 dias prorrog√°vel por mais 60; se n√£o convertida, perde efic√°cia (CF, art. 62).",
        tips: {
          lembrar: "MP: 60 + 60 dias.",
          pensar: "Perde efic√°cia se n√£o houver convers√£o.",
          organizar: "Prazo inicial e prorroga√ß√£o autom√°tica.",
          eliminar: "Se o prazo for diferente do 60+60, tende a estar errado."
        }
      }
    ];

    const levels = [
      { label: "Inst√°vel", days: 1 },
      { label: "Assistido", days: 3 },
      { label: "Compreendido", days: 7 },
      { label: "Revis√£o leve", days: 15 },
      { label: "Revis√£o leve", days: 45 }
    ];

    const state = {
      currentFragment: null,
      rainActive: false,
      progress: loadProgress()
    };

    let rainContext = null;
    let rainSource = null;
    let rainGain = null;
    let rainFilter = null;

    const screens = Array.from(document.querySelectorAll('.screen'));
    const menu = document.getElementById('mainMenu');

    function showScreen(id) {
      screens.forEach(screen => screen.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if (id === 'screen-start') {
        menu.style.display = 'none';
      } else {
        menu.style.display = 'flex';
        menu.querySelectorAll('button').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.screen === id);
        });
      }
    }

    function loadProgress() {
      try {
        return JSON.parse(localStorage.getItem('limiar-progress')) || {};
      } catch (error) {
        return {};
      }
    }

    function saveProgress() {
      localStorage.setItem('limiar-progress', JSON.stringify(state.progress));
    }

    function getFragmentProgress(id) {
      if (!state.progress[id]) {
        state.progress[id] = { level: 0, dueAt: null };
      }
      return state.progress[id];
    }

    function scheduleNext(id, correct) {
      const progress = getFragmentProgress(id);
      const now = new Date();
      if (correct) {
        progress.level = Math.min(progress.level + 1, levels.length - 1);
      } else if (progress.level < 3) {
        progress.level = 0;
      }
      const days = levels[progress.level].days;
      progress.dueAt = new Date(now.getTime() + days * 24 * 60 * 60 * 1000).toISOString();
      saveProgress();
    }

    function formatDue(dueAt) {
      if (!dueAt) return 'Sem agendamento';
      const now = new Date();
      const due = new Date(dueAt);
      const diff = Math.ceil((due - now) / (24 * 60 * 60 * 1000));
      if (diff <= 0) return 'Rever hoje';
      if (diff === 1) return 'Rever amanh√£';
      return `Rever em ${diff} dias`;
    }

    function renderFragments() {
      const list = document.getElementById('fragmentList');
      list.innerHTML = '';
      fragments.forEach(fragment => {
        const progress = getFragmentProgress(fragment.id);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="small">${fragment.location}</div>
          <h3>${fragment.title}</h3>
          <p class="small">${levels[progress.level].label} ¬∑ ${formatDue(progress.dueAt)}</p>
          <button>Entrar no fragmento</button>
        `;
        card.querySelector('button').addEventListener('click', () => openFragment(fragment.id));
        list.appendChild(card);
      });
    }

    function openFragment(id) {
      const fragment = fragments.find(item => item.id === id);
      state.currentFragment = fragment;
      const progress = getFragmentProgress(id);
      document.getElementById('fragmentLocation').textContent = fragment.location;
      document.getElementById('fragmentTitle').textContent = fragment.title;
      document.getElementById('fragmentText').textContent = fragment.text;
      document.getElementById('fragmentStatus').textContent = `${levels[progress.level].label} ¬∑ ${formatDue(progress.dueAt)}`;
      showScreen('screen-fragment');
    }

    function renderHints() {
      const fragment = state.currentFragment;
      document.getElementById('hintPrompt').textContent = fragment.text;
      const buttons = document.getElementById('hintButtons');
      const hintContent = document.getElementById('hintContent');
      hintContent.style.display = 'none';
      hintContent.textContent = '';
      const hints = [
        { key: 'lembrar', label: 'Lembrar', icon: 'üß©' },
        { key: 'pensar', label: 'Pensar', icon: 'üß†' },
        { key: 'organizar', label: 'Organizar', icon: 'üó∫Ô∏è' },
        { key: 'eliminar', label: 'Eliminar', icon: 'üßπ' }
      ];
      buttons.innerHTML = '';
      hints.forEach(hint => {
        const btn = document.createElement('button');
        btn.textContent = `${hint.icon} ${hint.label}`;
        btn.addEventListener('click', () => {
          hintContent.style.display = 'block';
          hintContent.textContent = fragment.tips[hint.key];
        });
        buttons.appendChild(btn);
      });
      showScreen('screen-hints');
    }

    function showFeedback(correct) {
      const fragment = state.currentFragment;
      const feedbackTitle = document.getElementById('feedbackTitle');
      const feedbackText = document.getElementById('feedbackText');
      const feedbackDetail = document.getElementById('feedbackDetail');
      if (correct) {
        feedbackTitle.textContent = 'Fragmento compreendido';
        feedbackText.textContent = 'Voc√™ atravessou com clareza. O ritmo segue silencioso.';
        feedbackDetail.style.display = 'none';
      } else {
        feedbackTitle.textContent = 'Fragmento inst√°vel';
        feedbackText.textContent = `Resposta correta: ${fragment.answer ? 'Verdadeiro' : 'Falso'}.`;
        feedbackDetail.style.display = 'block';
        feedbackDetail.innerHTML = `<strong>Por qu√™:</strong> ${fragment.rationale}`;
      }
      showScreen('screen-feedback');
    }

    function renderReviewList() {
      const list = document.getElementById('reviewList');
      const items = fragments.map(fragment => {
        const progress = getFragmentProgress(fragment.id);
        return {
          fragment,
          progress,
          dueAt: progress.dueAt ? new Date(progress.dueAt) : null
        };
      }).sort((a, b) => {
        if (!a.dueAt && !b.dueAt) return 0;
        if (!a.dueAt) return 1;
        if (!b.dueAt) return -1;
        return a.dueAt - b.dueAt;
      });

      list.innerHTML = '';
      if (!items.length) {
        list.textContent = 'Nenhum fragmento registrado.';
        return;
      }

      items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'list-item';
        row.innerHTML = `
          <div class="small">üîÅ ${item.fragment.title}</div>
          <div>${item.fragment.location}</div>
          <div class="small">${formatDue(item.progress.dueAt)}</div>
        `;
        row.addEventListener('click', () => openFragment(item.fragment.id));
        list.appendChild(row);
      });
    }

    function initMenu() {
      menu.querySelectorAll('button').forEach(button => {
        button.addEventListener('click', () => {
          const target = button.dataset.screen;
          if (target === 'screen-explore') {
            renderFragments();
          }
          if (target === 'screen-review') {
            renderReviewList();
          }
          showScreen(target);
        });
      });
    }

    document.getElementById('enterBtn').addEventListener('click', () => {
      renderFragments();
      showScreen('screen-explore');
    });

    document.getElementById('btnDoubt').addEventListener('click', renderHints);
    document.getElementById('backToFragment').addEventListener('click', () => showScreen('screen-fragment'));

    document.getElementById('btnTrue').addEventListener('click', () => {
      const correct = state.currentFragment.answer === true;
      scheduleNext(state.currentFragment.id, correct);
      showFeedback(correct);
      renderFragments();
      renderReviewList();
    });

    document.getElementById('btnFalse').addEventListener('click', () => {
      const correct = state.currentFragment.answer === false;
      scheduleNext(state.currentFragment.id, correct);
      showFeedback(correct);
      renderFragments();
      renderReviewList();
    });

    document.getElementById('backToExplore').addEventListener('click', () => {
      renderFragments();
      showScreen('screen-explore');
    });

    document.getElementById('rainToggle').addEventListener('click', (event) => {
      state.rainActive = !state.rainActive;
      event.target.classList.toggle('rain-active', state.rainActive);
      if (state.rainActive) {
        startRain();
      } else {
        stopRain();
      }
      event.target.textContent = state.rainActive ? 'Chuva ativa' : 'Ativar chuva';
    });

    const diaryInput = document.getElementById('diaryInput');
    const diaryStatus = document.getElementById('diaryStatus');
    diaryInput.value = localStorage.getItem('limiar-diary') || '';
    diaryInput.addEventListener('input', () => {
      localStorage.setItem('limiar-diary', diaryInput.value);
      diaryStatus.textContent = 'Salvo automaticamente.';
      clearTimeout(diaryInput._timer);
      diaryInput._timer = setTimeout(() => {
        diaryStatus.textContent = '';
      }, 2000);
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }

    initMenu();

    function startRain() {
      if (!rainContext) {
        rainContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (rainContext.state === 'suspended') {
        rainContext.resume();
      }
      if (rainSource) return;
      const buffer = rainContext.createBuffer(1, rainContext.sampleRate * 2, rainContext.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < data.length; i += 1) {
        data[i] = Math.random() * 2 - 1;
      }
      const source = rainContext.createBufferSource();
      source.buffer = buffer;
      source.loop = true;
      const highpass = rainContext.createBiquadFilter();
      highpass.type = 'highpass';
      highpass.frequency.value = 500;
      const lowpass = rainContext.createBiquadFilter();
      lowpass.type = 'lowpass';
      lowpass.frequency.value = 2500;
      const gain = rainContext.createGain();
      gain.gain.value = 0.12;
      source.connect(highpass);
      highpass.connect(lowpass);
      lowpass.connect(gain);
      gain.connect(rainContext.destination);
      source.start();
      rainSource = source;
      rainGain = gain;
      rainFilter = { highpass, lowpass };
    }

    function stopRain() {
      if (rainSource) {
        rainSource.stop();
        rainSource.disconnect();
      }
      if (rainGain) {
        rainGain.disconnect();
      }
      if (rainFilter) {
        rainFilter.highpass.disconnect();
        rainFilter.lowpass.disconnect();
      }
      rainSource = null;
      rainGain = null;
      rainFilter = null;
    }
  </script>
</body>
</html>
